# Flow æ•°æ®åŒæ­¥ç›®å½•ç»“æ„è¯´æ˜

## ğŸ“ ç›®å½•ç»“æ„è®¾è®¡

### ä¿®å¤åçš„æ­£ç¡®ç»“æ„

```
Application Support/com.example.flow/  (æˆ– Android: /data/data/com.moyoung.mario.flow/app_flutter/)
â”œâ”€â”€ sync_data/              â† å®é™…å­˜å‚¨ï¼Œè¢«åŒæ­¥åˆ°äº‘ç«¯
â”‚   â”œâ”€â”€ flow.db             â† SQLite æ•°æ®åº“
â”‚   â”œâ”€â”€ assets/             â† å›¾ç‰‡å’Œè§†é¢‘åŸä»¶
â”‚   â”‚   â”œâ”€â”€ asset_*.jpg
â”‚   â”‚   â”œâ”€â”€ asset_*.mp4
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ thumbnails/         â† ç¼©ç•¥å›¾
â”‚       â”œâ”€â”€ thumb_*.jpg
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ flow.db -> sync_data/flow.db              â† è½¯é“¾æ¥
â”œâ”€â”€ assets/ -> sync_data/assets/              â† è½¯é“¾æ¥
â”œâ”€â”€ thumbnails/ -> sync_data/thumbnails/      â† è½¯é“¾æ¥
â”‚
â”œâ”€â”€ .flow-repo/             â† CDC åŒæ­¥ä»“åº“ï¼ˆä¸è¢«åŒæ­¥ï¼‰
â”‚   â”œâ”€â”€ indexes/            â† å¿«ç…§ç´¢å¼•
â”‚   â”œâ”€â”€ objects/            â† æ•°æ®å—ï¼ˆåŠ å¯†ï¼‰
â”‚   â”œâ”€â”€ files/              â† æ–‡ä»¶å…ƒæ•°æ®ï¼ˆåŠ å¯†ï¼‰
â”‚   â””â”€â”€ refs/               â† å¼•ç”¨
â”‚
â””â”€â”€ flutter_assets/         â† Flutter åº”ç”¨èµ„æºï¼ˆä¸åŒæ­¥ï¼‰
    â”œâ”€â”€ isolate_snapshot_data
    â”œâ”€â”€ kernel_blob.bin
    â””â”€â”€ vm_snapshot_data
```

## ğŸ”„ å·¥ä½œåŸç†

### 1. åˆå§‹åŒ–æ—¶ï¼ˆé¦–æ¬¡å¯åŠ¨ï¼‰

```
åŸå§‹ç»“æ„:
â”œâ”€â”€ flow.db
â”œâ”€â”€ assets/
â””â”€â”€ thumbnails/

æ‰§è¡Œ _initializeSyncStructure() å:
â”œâ”€â”€ sync_data/              â† æ–°å»º
â”‚   â”œâ”€â”€ flow.db             â† ç§»åŠ¨åˆ°è¿™é‡Œ
â”‚   â”œâ”€â”€ assets/             â† ç§»åŠ¨åˆ°è¿™é‡Œ
â”‚   â””â”€â”€ thumbnails/         â† ç§»åŠ¨åˆ°è¿™é‡Œ
â”‚
â”œâ”€â”€ flow.db -> sync_data/flow.db        â† è½¯é“¾æ¥
â”œâ”€â”€ assets/ -> sync_data/assets/        â† è½¯é“¾æ¥
â””â”€â”€ thumbnails/ -> sync_data/thumbnails/â† è½¯é“¾æ¥
```

### 2. åº”ç”¨è®¿é—®æ•°æ®

åº”ç”¨ä»£ç ä½¿ç”¨åŸå§‹è·¯å¾„ï¼š
```dart
// åº”ç”¨ä»£ç ä¸éœ€è¦æ”¹å˜
final dbPath = path.join(appDocPath, 'flow.db');  // è®¿é—®è½¯é“¾æ¥
final assetsDir = path.join(appDocPath, 'assets');  // è®¿é—®è½¯é“¾æ¥

// å®é™…è®¿é—®çš„æ˜¯
// sync_data/flow.db
// sync_data/assets/
```

**è½¯é“¾æ¥çš„å¥½å¤„**ï¼š
- âœ… åº”ç”¨ä»£ç æ— éœ€ä¿®æ”¹
- âœ… æ•°æ®å®é™…å­˜å‚¨åœ¨ sync_data
- âœ… é€æ˜è®¿é—®

### 3. åŒæ­¥åˆ°äº‘ç«¯

```
sync_data/                  â†’ äº‘ç«¯ (S3)
â”œâ”€â”€ flow.db                 â†’ objects/xx/xxxxx (åŠ å¯†)
â”œâ”€â”€ assets/                 â†’ objects/xx/xxxxx (åŠ å¯†)
â””â”€â”€ thumbnails/             â†’ objects/xx/xxxxx (åŠ å¯†)
```

**ä¸åŒæ­¥çš„å†…å®¹**ï¼š
- âŒ `.flow-repo/` - æœ¬åœ°ä»“åº“å…ƒæ•°æ®
- âŒ `flutter_assets/` - Flutter åº”ç”¨èµ„æº
- âŒ `cache/` - ç¼“å­˜ç›®å½•
- âŒ `*.db-journal` - ä¸´æ—¶æ–‡ä»¶

## ğŸ“‹ åŒæ­¥çš„æ–‡ä»¶ç±»å‹

### åŒ…å«çš„æ–‡ä»¶

| æ–‡ä»¶/ç›®å½• | è¯´æ˜ | å¤§å°ä¼°è®¡ |
|-----------|------|----------|
| `flow.db` | SQLite æ•°æ®åº“ | ~æ•°ç™¾ MB |
| `assets/*.jpg` | å›¾ç‰‡åŸä»¶ | æ¯å¼  1-5 MB |
| `assets/*.mp4` | è§†é¢‘åŸä»¶ | æ¯ä¸ª 10-100 MB |
| `thumbnails/*.jpg` | ç¼©ç•¥å›¾ | æ¯å¼  50-200 KB |

### æ’é™¤çš„æ–‡ä»¶

| æ–‡ä»¶/ç›®å½• | åŸå›  |
|-----------|------|
| `flutter_assets/` | Flutter åº”ç”¨èµ„æºï¼Œä¸éœ€è¦åŒæ­¥ |
| `flow.db-journal` | SQLite ä¸´æ—¶æ–‡ä»¶ï¼Œä¸åº”åŒæ­¥ |
| `.flow-repo/` | æœ¬åœ°ä»“åº“ï¼ŒåŒ…å«å…ƒæ•°æ® |
| `cache/` | ç¼“å­˜æ•°æ® |

## ğŸ”§ åˆå§‹åŒ–æµç¨‹

### é¦–æ¬¡å¯åŠ¨æ—¶

```
1. æ£€æŸ¥ sync_data/ æ˜¯å¦å­˜åœ¨
   â”œâ”€ ä¸å­˜åœ¨ â†’ åˆ›å»ºç›®å½•
   â””â”€ å­˜åœ¨ â†’ è·³è¿‡

2. å¯¹äºæ¯ä¸ªéœ€è¦åŒæ­¥çš„é¡¹ç›® (flow.db, assets/, thumbnails/)
   â”œâ”€ æ£€æŸ¥åŸå§‹ä½ç½®æ˜¯å¦å­˜åœ¨
   â”œâ”€ å¦‚æœå­˜åœ¨ä¸”ä¸åœ¨ sync_data/
   â”‚  â”œâ”€ ç§»åŠ¨åˆ° sync_data/
   â”‚  â””â”€ åˆ›å»ºè½¯é“¾æ¥
   â””â”€ å¦‚æœå·²åœ¨ sync_data/ â†’ è·³è¿‡

3. åˆå§‹åŒ– CDC ä»“åº“
   â”œâ”€ åˆ›å»º .flow-repo/
   â””â”€ é…ç½®äº‘ç«¯è¿æ¥
```

### ä»£ç å®ç°

åœ¨ `SyncService._initRepository()` ä¸­è‡ªåŠ¨è°ƒç”¨ï¼š

```dart
await _initializeSyncStructure();
```

è¿™ä¼šï¼š
1. æ£€æŸ¥å¹¶åˆ›å»º `sync_data/` ç›®å½•
2. å°†ç°æœ‰æ–‡ä»¶ç§»åŠ¨åˆ° `sync_data/`
3. åˆ›å»ºè½¯é“¾æ¥æŒ‡å‘ `sync_data/` ä¸­çš„æ–‡ä»¶
4. åªåœ¨é¦–æ¬¡è¿è¡Œæ—¶æ‰§è¡Œï¼Œåç»­è·³è¿‡

## ğŸŒ è·¨å¹³å°åŒæ­¥

### macOS ç¤ºä¾‹

```
~/Library/Application Support/com.example.flow/
â””â”€â”€ sync_data/
    â”œâ”€â”€ flow.db
    â”œâ”€â”€ assets/
    â””â”€â”€ thumbnails/
```

### Android ç¤ºä¾‹

```
/data/data/com.moyoung.mario.flow/app_flutter/
â””â”€â”€ sync_data/
    â”œâ”€â”€ flow.db
    â”œâ”€â”€ assets/
    â””â”€â”€ thumbnails/
```

### åŒæ­¥é€»è¾‘

ä¸¤å°è®¾å¤‡çš„ `sync_data/` å†…å®¹é€šè¿‡äº‘ç«¯ä¿æŒä¸€è‡´ï¼š

```
macOS Device                     Cloud (S3)                    Android Device
sync_data/                       flow-data/                    sync_data/
â”œâ”€â”€ flow.db     â”€â”€â”€ åŒæ­¥ â”€â”€â”€â–º   â”œâ”€â”€ objects/...   â—„â”€â”€â”€ åŒæ­¥ â”€â”€â”€ â”œâ”€â”€ flow.db
â”œâ”€â”€ assets/                      â”œâ”€â”€ files/...                  â”œâ”€â”€ assets/
â””â”€â”€ thumbnails/                  â””â”€â”€ indexes/...                â””â”€â”€ thumbnails/
```

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. è½¯é“¾æ¥å¹³å°å·®å¼‚

- **macOS/Linux**: å®Œå…¨æ”¯æŒè½¯é“¾æ¥ âœ…
- **Android**: æ”¯æŒè½¯é“¾æ¥ï¼ˆéœ€è¦æƒé™ï¼‰âœ…
- **Windows**: éœ€è¦ç®¡ç†å‘˜æƒé™æˆ–å¼€å‘è€…æ¨¡å¼

å¦‚æœè½¯é“¾æ¥åˆ›å»ºå¤±è´¥ï¼š
- æ•°æ®å·²ç»åœ¨ `sync_data/` ä¸­
- åº”ç”¨å¯èƒ½éœ€è¦æ›´æ–°è·¯å¾„é…ç½®
- æˆ–è€…ç›´æ¥ä½¿ç”¨ `sync_data/` è·¯å¾„

### 2. é¦–æ¬¡åŒæ­¥æ³¨æ„

é¦–æ¬¡åŒæ­¥æ—¶ï¼š
1. ä¼šç§»åŠ¨ç°æœ‰æ–‡ä»¶åˆ° `sync_data/`
2. **ç¡®ä¿æ²¡æœ‰å…¶ä»–è¿›ç¨‹åœ¨ä½¿ç”¨è¿™äº›æ–‡ä»¶**
3. å»ºè®®åœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ

### 3. æ•°æ®å®‰å…¨

- âœ… ç§»åŠ¨æ“ä½œæ˜¯åŸå­æ€§çš„ï¼ˆrenameï¼‰
- âœ… è½¯é“¾æ¥åˆ›å»ºå¤±è´¥ä¸ä¼šå½±å“æ•°æ®
- âœ… æ•°æ®å§‹ç»ˆåœ¨æœ¬åœ°ä¿ç•™
- âœ… äº‘ç«¯æ•°æ®ç»è¿‡åŠ å¯†

## ğŸ“Š å­˜å‚¨ç©ºé—´å¯¹æ¯”

### ä¼˜åŒ–å‰ï¼ˆé”™è¯¯çš„å®ç°ï¼‰

```
åŒæ­¥æ•´ä¸ª app_flutter/ ç›®å½•ï¼š
- åŒ…å« flutter_assets/ (~50MBï¼Œä¸éœ€è¦åŒæ­¥)
- åŒ…å« cache/ (~100MBï¼Œä¸éœ€è¦åŒæ­¥)
- åŒ…å«ä¸´æ—¶æ–‡ä»¶

æ€»åŒæ­¥å¤§å°: ~500MB âŒ
```

### ä¼˜åŒ–åï¼ˆæ­£ç¡®çš„å®ç°ï¼‰

```
åªåŒæ­¥ sync_data/ ç›®å½•ï¼š
- flow.db (~200MB)
- assets/ (~100MB)
- thumbnails/ (~50MB)

æ€»åŒæ­¥å¤§å°: ~350MB âœ…
èŠ‚çœ: ~150MB (30%) âœ…
```

## ğŸ¯ éªŒè¯æ–¹æ³•

### æ£€æŸ¥ç›®å½•ç»“æ„

```bash
# macOS
cd ~/Library/Application\ Support/com.example.flow/
ls -la

# åº”è¯¥çœ‹åˆ°ï¼š
# sync_data/         (ç›®å½•)
# .flow-repo/        (ç›®å½•)
# flow.db            (è½¯é“¾æ¥ -> sync_data/flow.db)
# assets             (è½¯é“¾æ¥ -> sync_data/assets/)
# thumbnails         (è½¯é“¾æ¥ -> sync_data/thumbnails/)

# éªŒè¯è½¯é“¾æ¥
ls -l flow.db
# è¾“å‡º: flow.db -> sync_data/flow.db
```

### æ£€æŸ¥åŒæ­¥å†…å®¹

```bash
# æ£€æŸ¥ sync_data ç›®å½•å¤§å°
du -sh sync_data/

# æ£€æŸ¥ .flow-repo ç›®å½•
ls -la .flow-repo/
# åº”è¯¥çœ‹åˆ°: indexes/, objects/, files/, refs/
```

---

**æœ€åæ›´æ–°**: 2026-01-04  
**ä¿®å¤**: æ­£ç¡®çš„åŒæ­¥ç›®å½•ç»“æ„

