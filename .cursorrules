# Cursor Rules - Flutter Project Code Commit Specifications

## Code Commit Specifications

**IMPORTANT: All commit messages must be written in English.**

### Commit Message Format

Use Conventional Commits format:

```
<type>(<scope>): <subject>

<body>

<footer>
```

#### Type (Required)
- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation update
- `style`: Code formatting (doesn't affect code execution)
- `refactor`: Code refactoring
- `perf`: Performance optimization
- `test`: Testing related
- `chore`: Build process or auxiliary tool changes
- `ci`: CI configuration file and script changes

#### Scope (Optional)
- `ui`: User interface related
- `api`: API related
- `auth`: Authentication related
- `db`: Database related
- `config`: Configuration related
- `deps`: Dependency updates

#### Subject (Required)
- Use English description
- Start with lowercase
- No period at the end
- Concise and clear, no more than 50 characters

#### Body (Optional)
- Detailed description of changes
- Explain the reason and approach
- Can be multiple lines

#### Footer (Optional)
- Close issues: `Closes #123`
- Breaking changes: `BREAKING CHANGE: description`

### Commit Message Examples

```
feat(ui): add user login page

Implemented user login interface including username and password input fields and login button.
Added form validation logic.

Closes #45
```

```
fix(api): fix network request timeout issue

Increased default timeout from 5 seconds to 10 seconds to resolve request failures on slow networks.
```

```
refactor: refactor state management code

Migrated state management from Provider to Riverpod to improve code maintainability.
```

### Automated Commit Workflow

After completing code modifications and testing, follow these steps to commit:

1. Check code status: `git status`
2. Add modified files: `git add .`
3. Commit code (using standard commit message format)
4. Push to remote repository: `git push`

### Database Operation Documentation Standards

**IMPORTANT: All database operation changes must synchronously update database operation documentation**

#### Database Documentation Requirements

1. **Documentation Location**
   - Database documentation is located at: `docs/DATABASE.md`
   - Must synchronously update this document when modifying database-related code

2. **Content to Record**
   - **Table Structure Changes**: New tables, table structure modifications, table deletions
   - **Field Changes**: New fields, field type modifications, field deletions, field constraint changes
   - **Index Changes**: New indexes, index deletions, index optimizations
   - **Database Version Upgrades**: Version number changes, upgrade scripts, migration logic
   - **CRUD Operation Changes**: Add, modify, delete database operation methods
   - **Query Optimizations**: SQL query optimizations, performance improvements
   - **Data Migrations**: Data format changes, data cleanup scripts

3. **Documentation Update Timing**
   - Update documentation immediately after code modifications
   - Ensure documentation is updated before committing code
   - Documentation updates should be in the same commit as code modifications

4. **Documentation Format Requirements**
   - Use Markdown format
   - Record change date and version number
   - Explain reasons and impact scope in detail
   - Provide before/after comparisons (if applicable)
   - Record related code file paths

5. **Commit Standards**
   - Database-related commits should use `db` scope
   - Commit messages should include documentation update notes
   - Example: `feat(db): add user table and update database documentation`

### Database Migration Standards

**IMPORTANT: All database table structure changes must implement migration logic to ensure data is not lost when old users upgrade**

#### Migration Implementation Requirements

1. **Version Number Management**
   - Database version number must be incremented for each table structure change
   - Version numbers can only increase, not decrease
   - Current version number is recorded in the `version` parameter of `openDatabase()`

2. **Migration Code Location**
   - Migration logic must be implemented in the `_onUpgrade()` method
   - File path: `lib/services/database_service.dart`

3. **Migration Code Standards**
   ```dart
   Future<void> _onUpgrade(Database db, int oldVersion, int newVersion) async {
     // Use if (oldVersion < X) for step-by-step upgrades to ensure cross-version compatibility
     if (oldVersion < 2) {
       // Version 1 -> 2 migration logic
       await db.execute('ALTER TABLE entries ADD COLUMN weather TEXT');
     }
     if (oldVersion < 3) {
       // Version 2 -> 3 migration logic
       await db.execute('CREATE TABLE tags (...)');
     }
   }
   ```

4. **Common Migration Scenarios**
   | Scenario | SQL Statement |
   |----------|---------------|
   | Add field | `ALTER TABLE table ADD COLUMN field TYPE` |
   | Add field with default | `ALTER TABLE table ADD COLUMN field TYPE DEFAULT value` |
   | Create new table | `CREATE TABLE table (...)` |
   | Create index | `CREATE INDEX idx_name ON table (column)` |
   | Drop table | `DROP TABLE IF EXISTS table` |

5. **SQLite Limitations**
   - SQLite doesn't support directly deleting columns or modifying column types
   - Need to use "rebuild table" approach:
     1. Create new table (new structure)
     2. Copy data to new table
     3. Delete old table
     4. Rename new table
     5. Rebuild indexes

6. **Synchronous Update Requirements**
   - `_onCreate()` method must contain complete latest table structure (for new installations)
   - `_onUpgrade()` method must contain upgrade logic from any old version
   - `docs/DATABASE.md` must record version changes and migration notes

#### Migration Checklist

Before committing database changes, confirm:

- [ ] Database version number has been incremented
- [ ] `_onCreate()` contains complete new table structure
- [ ] `_onUpgrade()` contains migration logic
- [ ] Migration logic uses `if (oldVersion < X)` format
- [ ] Upgrade process tested on real device/simulator
- [ ] `docs/DATABASE.md` has been updated with version changes

### API Key and Sensitive Information Management Standards

**IMPORTANT: All API Keys, secrets, passwords, and other sensitive information must be managed using configuration files, not hardcoded in code**

#### Configuration File Management Requirements

1. **Configuration File Structure**
   - Actual configuration file: `lib/config.dart` (not committed to Git)
   - Example template file: `lib/config.example.dart` (committed to Git)
   - Configuration documentation: `CONFIG_SETUP.md` (committed to Git)

2. **Configuration File Format**
   ```dart
   /// Application Configuration
   /// Note: This file contains sensitive information and should not be committed to version control
   class AppConfig {
     // API Keys
     static const String amapApiKey = 'YOUR_API_KEY';
     
     // Database Configuration
     static const String dbEncryptionKey = 'YOUR_KEY';
     
     // Other sensitive configurations...
   }
   ```

3. **Example Template Format**
   ```dart
   /// Application Configuration Example File
   /// Usage:
   /// 1. Copy this file as config.dart
   /// 2. Fill in your actual keys in config.dart
   /// 3. config.dart will not be committed to Git
   class AppConfig {
     // Amap API Key
     // Get it at: https://lbs.amap.com/
     static const String amapApiKey = 'YOUR_AMAP_API_KEY_HERE';
     
     // Other configurations...
   }
   ```

4. **Using Configuration**
   ```dart
   import '../config.dart';
   
   class SomeService {
     static const String _apiKey = AppConfig.amapApiKey;
     // Use the key from configuration
   }
   ```

5. **.gitignore Configuration**
   - Must add `lib/config.dart` to `.gitignore`
   - Ensure sensitive information is not committed to version control
   ```gitignore
   # Configuration file (contains sensitive information, do not commit)
   lib/config.dart
   ```

6. **Steps When Adding New Keys**
   - Add actual key in `lib/config.dart`
   - Add placeholder in `lib/config.example.dart`
   - Update documentation in `CONFIG_SETUP.md`
   - Reference using `AppConfig.xxxKey` in code

7. **Prohibited Practices**
   ❌ Hardcode API Keys in code
   ```dart
   // Wrong example
   static const String _apiKey = '498fb9da60888b1533cdcaf8f7d9c13d';
   ```
   
   ✅ Read from configuration file
   ```dart
   // Correct example
   import '../config.dart';
   static const String _apiKey = AppConfig.amapApiKey;
   ```

8. **Development Environment Setup**
   - After cloning the project, team members need to copy and configure:
     ```bash
     cp lib/config.example.dart lib/config.dart
     # Then edit config.dart and fill in actual keys
     ```

9. **CI/CD Configuration**
   - In CI/CD environment, need to inject configuration through environment variables or secret management services
   - Do not write keys in plaintext in CI configuration files

#### Security Checklist

Before committing code, confirm:

- [ ] All API Keys and secrets have been moved to `config.dart`
- [ ] `config.dart` has been added to `.gitignore`
- [ ] `config.example.dart` has been updated (using placeholders)
- [ ] `CONFIG_SETUP.md` has been updated with instructions
- [ ] No hardcoded sensitive information in code
- [ ] No leaked sensitive information in Git history (use `git filter-branch` if needed)

### Notes

- Each commit should be a complete feature or fix
- Avoid committing unfinished code
- Ensure code runs properly before committing
- Keep commit history clear and meaningful
- **Do not commit sensitive information (API keys, passwords, etc.), must use configuration files**
- Do not commit build artifacts (build/, .dart_tool/, etc.)
- **Database operation changes must synchronously update database documentation**
- **Database table structure changes must implement migration logic**
- **All keys must be managed through configuration files, not hardcoded**


