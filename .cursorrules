# Cursor Rules - Flutter 项目代码提交规范

## 代码提交规范



### 提交信息格式规范

使用约定式提交（Conventional Commits）格式：

```
<type>(<scope>): <subject>

<body>

<footer>
```

#### Type 类型（必填）
- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更新
- `style`: 代码格式调整（不影响代码运行）
- `refactor`: 代码重构
- `perf`: 性能优化
- `test`: 测试相关
- `chore`: 构建过程或辅助工具的变动
- `ci`: CI 配置文件和脚本的变更

#### Scope 范围（可选）
- `ui`: 用户界面相关
- `api`: API 相关
- `auth`: 认证相关
- `db`: 数据库相关
- `config`: 配置相关
- `deps`: 依赖更新

#### Subject 主题（必填）
- 使用中文或英文描述
- 首字母小写
- 结尾不加句号
- 简洁明了，不超过 50 个字符

#### Body 正文（可选）
- 详细描述修改内容
- 说明修改的原因和方式
- 可以多行

#### Footer 脚注（可选）
- 关闭的 issue：`Closes #123`
- 破坏性变更：`BREAKING CHANGE: 描述变更内容`

### 提交信息示例

```
feat(ui): 添加用户登录页面

实现了用户登录界面，包括用户名和密码输入框，以及登录按钮。
添加了表单验证逻辑。

Closes #45
```

```
fix(api): 修复网络请求超时问题

将默认超时时间从 5 秒增加到 10 秒，解决网络较慢时的请求失败问题。
```

```
refactor: 重构状态管理代码

将状态管理从 Provider 迁移到 Riverpod，提升代码可维护性。
```

### 自动化提交流程

在完成代码修改和测试后，按照以下步骤提交：

1. 检查代码状态：`git status`
2. 添加修改的文件：`git add .`
3. 提交代码（使用规范的提交信息格式）
4. 推送到远程仓库：`git push`

### 数据库操作文档规范

**重要：所有数据库操作修改必须同步更新数据库操作文档**

#### 数据库操作文档要求

1. **文档位置**
   - 数据库操作文档位于：`docs/DATABASE.md`
   - 每次修改数据库相关代码时，必须同步更新此文档

2. **需要记录的内容**
   - **表结构变更**：新增表、修改表结构、删除表
   - **字段变更**：新增字段、修改字段类型、删除字段、字段约束变更
   - **索引变更**：新增索引、删除索引、索引优化
   - **数据库版本升级**：版本号变更、升级脚本、迁移逻辑
   - **CRUD 操作变更**：新增、修改、删除数据库操作方法
   - **查询优化**：SQL 查询优化、性能改进
   - **数据迁移**：数据格式变更、数据清理脚本

3. **文档更新时机**
   - 在代码修改完成后立即更新文档
   - 在提交代码前必须确保文档已更新
   - 文档更新应该与代码修改在同一提交中

4. **文档格式要求**
   - 使用 Markdown 格式
   - 记录变更日期和版本号
   - 详细说明变更原因和影响范围
   - 提供变更前后的对比（如适用）
   - 记录相关的代码文件路径

5. **提交规范**
   - 数据库相关提交的 scope 应使用 `db`
   - 提交信息应包含文档更新说明
   - 示例：`feat(db): 添加用户表并更新数据库文档`

### 数据库迁移规范

**重要：所有数据库表结构变更必须实现迁移逻辑，确保老用户升级时数据不丢失**

#### 迁移实现要求

1. **版本号管理**
   - 每次表结构变更必须增加数据库版本号
   - 版本号只能递增，不能降低
   - 当前版本号记录在 `openDatabase()` 的 `version` 参数中

2. **迁移代码位置**
   - 迁移逻辑必须在 `_onUpgrade()` 方法中实现
   - 文件路径：`lib/services/database_service.dart`

3. **迁移代码规范**
   ```dart
   Future<void> _onUpgrade(Database db, int oldVersion, int newVersion) async {
     // 使用 if (oldVersion < X) 逐版本升级，确保跨版本兼容
     if (oldVersion < 2) {
       // 版本 1 -> 2 的迁移逻辑
       await db.execute('ALTER TABLE entries ADD COLUMN weather TEXT');
     }
     if (oldVersion < 3) {
       // 版本 2 -> 3 的迁移逻辑
       await db.execute('CREATE TABLE tags (...)');
     }
   }
   ```

4. **常见迁移场景**
   | 场景 | SQL 语句 |
   |------|---------|
   | 添加字段 | `ALTER TABLE table ADD COLUMN field TYPE` |
   | 添加字段（带默认值） | `ALTER TABLE table ADD COLUMN field TYPE DEFAULT value` |
   | 创建新表 | `CREATE TABLE table (...)` |
   | 创建索引 | `CREATE INDEX idx_name ON table (column)` |
   | 删除表 | `DROP TABLE IF EXISTS table` |

5. **SQLite 限制处理**
   - SQLite 不支持直接删除列、修改列类型
   - 需要通过"重建表"方式处理：
     1. 创建新表（新结构）
     2. 复制数据到新表
     3. 删除旧表
     4. 重命名新表
     5. 重建索引

6. **同步更新要求**
   - `_onCreate()` 方法必须包含完整的最新表结构（新安装用户使用）
   - `_onUpgrade()` 方法必须包含从任意旧版本升级的逻辑
   - `docs/DATABASE.md` 必须记录版本变更和迁移说明

#### 迁移检查清单

在提交数据库变更前，请确认：

- [ ] 数据库版本号已递增
- [ ] `_onCreate()` 包含完整的新表结构
- [ ] `_onUpgrade()` 包含迁移逻辑
- [ ] 迁移逻辑使用 `if (oldVersion < X)` 格式
- [ ] 已在真机/模拟器上测试升级流程
- [ ] `docs/DATABASE.md` 已更新版本变更记录

### 注意事项

- 每次提交应该是一个完整的功能或修复
- 避免提交未完成的代码
- 提交前确保代码可以正常运行
- 保持提交历史的清晰和有意义
- 不要提交敏感信息（API keys、密码等）
- 不要提交构建产物（build/、.dart_tool/ 等）
- **数据库操作修改必须同步更新数据库操作文档**
- **数据库表结构变更必须实现迁移逻辑**


